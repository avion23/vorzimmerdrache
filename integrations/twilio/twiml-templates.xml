<?xml version="1.0" encoding="UTF-8"?>
<TwiML xmlns="http://twilio.com/xml/robot">

  <!-- Template 1: Initial call to installer with lead info (German voice) -->
  <!-- Used: When calling installer first -->
  <!-- Parameters: {customerName}, {address}, {leadType}, {callbackUrl}, {customerNumber} -->
  <Template id="installer-welcome">
    <Response>
      <Gather action="{{callbackUrl}}/gather" method="POST" numDigits="1" timeout="10">
        <Say language="de-DE" voice="alice">
          Guten Tag. Hier ist eine neue Anfrage für Sie.
          Kunde: {{customerName}}.
          Adresse: {{address}}.
          Auftragsart: {{leadType}}.
          Drücken Sie 1, um den Kunden direkt zu verbinden.
          Drücken Sie 2, um später zurückzurufen.
        </Say>
      </Gather>
      <Pause length="2"/>
      <Redirect method="POST">{{callbackUrl}}/timeout</Redirect>
    </Response>
  </Template>

  <!-- Template 2: DTMF response handling -->
  <!-- Parameters: {customerNumber}, {recordingUrl} -->
  <Template id="dtmf-response-1">
    <Response>
      <Say language="de-DE" voice="alice">
        Vielen Dank. Sie werden nun mit dem Kunden verbunden.
      </Say>
      <Dial callerId="{{callerId}}" action="{{callbackUrl}}/call-complete" method="POST">
        {{customerNumber}}
      </Dial>
    </Response>
  </Template>

  <Template id="dtmf-response-2">
    <Response>
      <Say language="de-DE" voice="alice">
        Danke. Wir haben vermerkt, dass Sie später zurückrufen werden.
        Die Kundendaten wurden Ihnen per SMS zugesendet.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <!-- Template 3: Invalid DTMF input -->
  <Template id="dtmf-invalid">
    <Response>
      <Say language="de-DE" voice="alice">
        Ungültige Eingabe. Bitte versuchen Sie es erneut.
      </Say>
      <Redirect method="POST">{{callbackUrl}}/welcome</Redirect>
    </Response>
  </Template>

  <!-- Template 4: Timeout - no response from installer -->
  <Template id="installer-timeout">
    <Response>
      <Say language="de-DE" voice="alice">
        Wir haben keine Eingabe erhalten.
        Die Kundendaten werden Ihnen per SMS gesendet.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <!-- Template 5: Call completed successfully -->
  <!-- Parameters: {callDuration} -->
  <Template id="call-completed">
    <Response>
      <Say language="de-DE" voice="alice">
        Das Gespräch ist beendet. Vielen Dank und einen schönen Tag.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <!-- Template 6: Customer busy or no answer - voicemail fallback -->
  <!-- Parameters: {voicemailUrl} -->
  <Template id="voicemail-fallback">
    <Response>
      <Say language="de-DE" voice="alice">
        Der Kunde ist nicht erreichbar.
        Sie können jetzt eine Nachricht hinterlassen.
      </Say>
      <Record action="{{callbackUrl}}/voicemail-complete" method="POST" maxLength="60" transcribe="true" transcribeCallback="{{callbackUrl}}/transcribe">
        <Say language="de-DE" voice="alice">
          Hinterlassen Sie bitte eine Nachricht nach dem Ton.
        </Say>
      </Record>
    </Response>
  </Template>

  <!-- Template 7: Voicemail recording complete -->
  <Template id="voicemail-complete">
    <Response>
      <Say language="de-DE" voice="alice">
        Danke für Ihre Nachricht. Wir haben sie gespeichert und senden sie dem Kunden zu.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <!-- Template 8: Call failed (installer number invalid, etc.) -->
  <Template id="call-failed">
    <Response>
      <Say language="de-DE" voice="alice">
        Entschuldigung, es ist ein Fehler aufgetreten.
        Wir senden Ihnen die Kundendaten per SMS.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <!-- Template 9: Retry attempt -->
  <!-- Parameters: {attempt}, {maxAttempts} -->
  <Template id="retry">
    <Response>
      <Say language="de-DE" voice="alice">
        Versuch {{attempt}} von {{maxAttempts}}.
      </Say>
      <Gather action="{{callbackUrl}}/gather" method="POST" numDigits="1" timeout="8">
        <Say language="de-DE" voice="alice">
          Drücken Sie 1, um den Kunden zu verbinden.
          Drücken Sie 2 für Rückruf später.
        </Say>
      </Gather>
      <Pause length="1"/>
      <Redirect method="POST">{{callbackUrl}}/timeout</Redirect>
    </Response>
  </Template>

  <!-- Template 10: Test voice greeting -->
  <Template id="test-greeting">
    <Response>
      <Say language="de-DE" voice="alice">
        Testanruf erfolgreich. Das Twilio System ist betriebsbereit.
      </Say>
      <Hangup/>
    </Response>
  </Template>

</TwiML>
